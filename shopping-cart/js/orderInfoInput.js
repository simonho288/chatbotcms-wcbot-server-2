"use strict";function SetupInputInfo(){if(null!=window._shoppingCart.input_info){var n=$("#billing_form"),e=$("#shipping_form"),a=window._shoppingCart.input_info.billing;n.find('[name="first_name"]').val(a.first_name),n.find('[name="last_name"]').val(a.last_name),n.find('[name="email"]').val(a.email),n.find('[name="phone"]').val(a.phone),n.find('[name="address1"]').val(a.address1),n.find('[name="address2"]').val(a.address2),n.find('[name="city"]').val(a.city),n.find('[name="state"]').val(a.state),n.find('[name="postal"]').val(a.postal),n.find('[name="country"]').dropdown("set selected",a.country),OnFormCountryChanged(n,a.country),n.find('[name="state"]').dropdown("set selected",a.state);var t=window._shoppingCart.input_info.shipping;e.find('[name="first_name"]').val(t.first_name),e.find('[name="last_name"]').val(t.last_name),e.find('[name="address1"]').val(t.address1),e.find('[name="address2"]').val(t.address2),e.find('[name="city"]').val(t.city),e.find('[name="postal"]').val(t.postal),e.find('[name="country"]').dropdown("set selected",t.country),OnFormCountryChanged(e,t.country),e.find('[name="state"]').dropdown("set selected",t.state),a.first_name===t.first_name&&a.last_name===t.last_name&&a.address1===t.address1&&a.address2===t.address2&&a.city===t.city&&a.state===t.state&&a.postal===t.postal&&a.country===t.country&&($('[name="same_as_billing"]').prop("checked","checked"),e.find("input").each(function(n){$(this).prop("disabled",!0)}),e.find(".dropdown").each(function(n){$(this).addClass("disabled")}))}}function SetupUI(){$(".ui.search.dropdown").dropdown(),$(".ui.checkbox").checkbox(),$("#btn_proceed").click(onBtnProceed),$("#btn_back").click(onBtnBack),$('[name="same_as_billing"]').change(onCbSameAsBilling),$('#billing_form [name="country"]').on("change",function(n){OnFormCountryChanged($("#billing_form"),n.target.value)}),$('#shipping_form [name="country"]').on("change",function(n){OnFormCountryChanged($("#shipping_form"),n.target.value)}),$(".loading_wrapper").hide(),$(".loaded_wrapper").show()}function LoadShoppingCart(){return $.ajax({method:"GET",url:"ws/db_loadcart",data:{uid:window._userId,rid:window._recipientId}})}function CalcOrderTotal(){var a=0;$.each(window._shoppingCart.cart_items,function(n,e){a+=e._qty*e._unitPrice});var n=util.ParseCurrencyToDisp(window._shoppingCart.server_settings.currency,a);$("#order_total").html(n),$("#total_div").show()}function ExtractCountries(){var r={};$.each(window._shoppingCart.server_settings.country.options,function(n,e){var a=n.split(":"),t=a[0],i=e.split(" - "),o=i[0];null==r[t]?(r[t]={name:o},1<a.length&&(r[t].states={},r[t].states[a[1]]=i[1])):r[t].states[a[1]]=i[1]}),window._countries=r}function onCbSameAsBilling(n){var t=this.checked,i=$("#billing_form"),e=$("#shipping_form");if(i.find('[name="country"]').val()!=e.find('[name="country"]').val()){var a=i.find('[name="state"] > option').clone(),o=e.find('[name="state"]');o.dropdown("clear"),o.empty().append(a)}e.find("input, select").each(function(n){var e=$(this).prop("name");if(0<e.length){if(t){var a=i.find('[name="'+e+'"]').val();"SELECT"===this.tagName?($(this).dropdown("setup select"),$(this).dropdown("set selected",a),$(this).dropdown("refresh")):$(this).val(a)}"INPUT"===this.tagName?$(this).prop("disabled",t):"SELECT"===this.tagName&&(t?$(this).parent().addClass("disabled"):$(this).parent().removeClass("disabled"))}})}function CountryCommonBehavior(n){var a='<option value="">Type to search</option>',e=n.find('[name="country"]');$.each(window._countries,function(n,e){a+='<option value="'+n+'">'+e.name+"</option>"}),e.html(a),e.dropdown("refresh")}function SetupBillingForm(){var n=$("#billing_form");CountryCommonBehavior(n),n.form({on:"blur",inline:!0,fields:{first_name:{identifier:"first_name",rules:[{type:"empty"}]},last_name:{identifier:"last_name",rules:[{type:"empty"}]},email:{identifier:"email",rules:[{type:"email"}]},phone:{identifier:"phone",rules:[{type:"empty"}]},address1:{identifier:"address1",rules:[{type:"empty"}]},postal:{identifier:"postal",rules:[{type:"regExp",value:"/^[a-zA-Z0-9]*$/",prompt:"Alphanumeric characters only"}]},country:{identifier:"country",rules:[{type:"empty"}]}}}),n.submit(function(n){if(!$(this).form("is valid"))return n.preventDefault(),!1;var e='<input type="hidden" name="payment_gateway" value="'+window.payment_gateway+'" />';return $(this).append(e),!0})}function SetupShippingForm(){var n=$("#shipping_form");CountryCommonBehavior(n),n.form({on:"blur",inline:!0,fields:{first_name:{identifier:"first_name",rules:[{type:"empty"}]},last_name:{identifier:"last_name",rules:[{type:"empty"}]},address1:{identifier:"address1",rules:[{type:"empty"}]},postal:{identifier:"postal",rules:[{type:"regExp",value:"/^[a-zA-Z0-9]*$/",prompt:"Can't contains hypen"}]},country:{identifier:"country",rules:[{type:"empty"}]}}}),n.submit(function(n){if(!$(this).form("is valid"))return n.preventDefault(),!1;var e='<input type="hidden" name="payment_gateway" value="'+window.payment_gateway+'" />';return $(this).append(e),!0})}function OnFormCountryChanged(n,e){var a,t=n.find('[name="state"]'),i=window._countries[e].states;null==i?a='<option value="">Type to search</option>':(a='<option value="">Type to search</option>',$.each(i,function(n,e){a+='<option value="'+n+'">'+e+"</option>"})),t.html(a),t.dropdown("clear"),t.dropdown("refresh"),t.dropdown("setup select")}function onBtnProceed(n){if($("#billing_form").form("validate form")){var e=$('[name="same_as_billing"]').prop("checked"),a=null;if(e?a=$('#billing_form [name="country"]').val():$("#shipping_form").form("validate form")&&(a=$('#shipping_form [name="country"]').val()),a){var t=$("#billing_form"),i={billing:{first_name:t.find('[name="first_name"]').val(),last_name:t.find('[name="last_name"]').val(),email:t.find('[name="email"]').val(),phone:t.find('[name="phone"]').val(),address1:t.find('[name="address1"]').val(),address2:t.find('[name="address2"]').val(),city:t.find('[name="city"]').val(),state:t.find('[name="state"]').val(),postal:t.find('[name="postal"]').val(),country:t.find('[name="country"]').val()}};if(e){var o=JSON.stringify(i.billing);i.shipping=JSON.parse(o)}else t=$("shipping_form"),i.shipping={first_name:t.find('[name="first_name"]').val(),last_name:t.find('[name="last_name"]').val(),address1:t.find('[name="address1"]').val(),address2:t.find('[name="address2"]').val(),city:t.find('[name="city"]').val(),state:t.find('[name="state"]').val(),postal:t.find('[name="postal"]').val(),country:t.find('[name="country"]').val()};EnableAllButtons(!1),window._shoppingCart.input_info=i,SaveCart().done(function(n){"ok"===n&&(window.location.href="mwp?page=orderShipping&uid="+window._userId+"&rid="+window._recipientId)}).fail(function(n,e,a){EnableAllButtons(!0),$.alert({type:"red",useBootstrap:!1,title:n,content:a.responseText})})}}}function onBtnBack(n){var e=$("#dlg_discardwarn");e.modal("show"),e.find("#btn_ok").click(function(n){EnableAllButtons(!1);var e="mwp?page=shopCart&uid="+window._userId+"&rid="+window._recipientId;window.location.href=e}),e.find("#btn_cancel").click(function(n){$("#dlg_discardwarn").modal("hide")})}function SaveCart(){return delete window._shoppingCart.cart_items,delete window._shoppingCart.server_settings,delete window._shoppingCart.order_pool,$.ajax({type:"POST",url:"ws/db_savecart",data:JSON.stringify({userId:window._userId,recipientId:window._recipientId,cart:window._shoppingCart}),contentType:"application/json"})}function EnableAllButtons(n){n?($("#btn_proceed").removeClass("disabled loading"),$("#btn_back").removeClass("disabled loading")):($("#btn_proceed").addClass("disabled loading"),$("#btn_back").addClass("disabled loading"))}$(document).ready(function(){CalcOrderTotal(),ExtractCountries(),SetupBillingForm(),SetupShippingForm(),SetupInputInfo(),SetupUI()});